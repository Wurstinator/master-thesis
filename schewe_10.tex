



\begin{defn}
	Let $\mathcal{A} = (Q, \Sigma, q_0, \delta, c)$ be a deterministic parity automaton. For $w \in \Sigma^* \cup \Sigma^\omega$ and $q \in Q$, we define $\lambda_\mathcal{A}(q, w) \in \mathbb{N}^{1+|w|}$ as follows: Let $q_0 q_1 \dots \in Q^{1+|w|}$ be the unique run of $\mathcal{A}$ on $w$. Then $\lambda_\mathcal{A}(q, w)(n) = c(q_n)$.
	
	Two DPAs $\mathcal{A}$ and $\mathcal{B}$ are \textbf{priority almost-equivalent}, if for all words $\alpha \in \Sigma^\omega$, $\lambda_\mathcal{A}(q_0^\mathcal{A}, \alpha)$ and $\lambda_\mathcal{B}(q_0^\mathcal{B}, \alpha)$ differ in only finitely many positions.
	We call two states $p, q \in Q$ of $\mathcal{A}$ priority almost-equivalent, $\mathcal{A}_q$ and $\mathcal{A}_p$ are priority almost-equivalent, where $\mathcal{A}_q$ behaves like $\mathcal{A}$ with initial state $q$.
	
	We define the \textbf{reachability order} $\preceq_\text{reach}^\mathcal{A} \subseteq Q \times Q$ as $p \preceq_\text{reach}^\mathcal{A} q$ iff $q$ is reachable from $p$. (\enquote{$p$ is closer to $q_0$ than $q$}). Note that $p \preceq_\text{reach}^\mathcal{A} q$ and $q \preceq_\text{reach}^\mathcal{A} p$ together mean that $p$ and $q$ reside in the same SCC.
\end{defn}

\begin{lem}
	Priority almost-equivalence is a congruence relation.
\end{lem}

\begin{defn}
	Let $\mathcal{A} = (Q, \Sigma, q_0, \delta, c)$ be a DPA and let $\sim \subseteq Q \times Q$ be a congruence relation on $\mathcal{A}$. We define the \textbf{Schewe} automaton $\mathcal{S}$ as follows:
	
	For each state $q$, let $[q]_\sim = \{ p \in Q \mid q \sim p \}$ be its equivalence class of $\sim$ and let $\bigslant{Q}{\sim} = \{[q]_\sim \mid q \in Q\}$ be the set of equivalence classes. For each such class $\mathfrak{c}$ we fix a representative $r_\mathfrak{c} \in \mathfrak{c}$ which is $\preceq_\text{reach}^\mathcal{A}$-maximal in its class, meaning that all states in $\mathfrak{c}$ that are reachable from $r_\mathfrak{c}$ are also in its SCC. 
	
	The automaton is then almost the same as the original DPA, with only a few modifications. Namely, $\mathcal{S} = (Q, \Sigma, r_{[q_0]_\sim}, \delta_\mathcal{S}, c)$.
	
	For each transition $\delta_\mathcal{S}(q, a)$, let $\delta(q, a) = p$. If $q \prec_\text{reach}^\mathcal{A} r_{[p]_\sim}$ (i.e. $q$ is not reachable from the representative of $[p]_\sim$), then $\delta_\mathcal{S}(q, a) = r_{[p]_\sim}$. Otherwise, we keep $\delta_\mathcal{S}(q, a) = p$. In other words, every time a transition moves to a different quotient class, it skips to the representative which lies as \enquote{deep} inside the automaton as possible.
\end{defn}

\begin{lem}
	For a given $\mathcal{A}$ and $\sim$, the Schewe automaton $\mathcal{S}$ can be computed in $\mathcal{O}(|\mathcal{A}|)$.
\end{lem}

\begin{proof}
	Using e.g. Kosaraju's algorithm \ref{}, the SCCs of $\mathcal{A}$ can be computed in $\mathcal{O}(|\mathcal{A}|)$ if we assume an adjacency list or similar as the underlying data structure. A topological sorting of the states and therefore the SCCs can then be computed in $\mathcal{O}(|\mathcal{A}|)$ again, e.g. by DFS.
\end{proof}

We focus on a specialized version of the Schewe automaton. Let $\sim$ be the priority equivalence and let $\mathcal{S}$ be the according automaton. We define $\mathcal{S}_m$ as the Moore-minimization of $\mathcal{S}$.

\begin{lem}
	Priority almost-equivalence implies language equivalence.
\end{lem}

\begin{proof}
	Let $\mathcal{A} = (Q_\mathcal{A}, \Sigma, q_0^\mathcal{A}, \delta_\mathcal{A}, c_\mathcal{A})$ and $\mathcal{B} = (Q_\mathcal{B}, \Sigma, q_0^\mathcal{B}, \delta_\mathcal{B}, c_\mathcal{B})$ be two DPA that are priority almost-equivalent and assume towards a contradiction that they are not language equivalent. Due to symmetry we can assume that there is a $w \in L(\mathcal{A}) \setminus L(\mathcal{B})$. 
	
	Consider $\alpha = \lambda_\mathcal{A}(q_0^\mathcal{A}, w)$ and $\beta = \lambda_\mathcal{B}(q_0^\mathcal{B}, w)$, the priority outputs of the automata on $w$. By choice of $w$, we know that $a := \max \text{Inf}(\alpha)$ is even and $b := \max \text{Inf}(\beta)$ is odd. Without loss of generality, assume $a > b$. That means $a$ is seen only finitely often in $\beta$ but infinitely often in $a$. Hence, $\alpha$ and $\beta$ differ at infinitely many positions where $a$ occurs in $\alpha$. That would mean $w$ is a witness that the two automata are not priority almost-equivalent, contradicting our assumption.
\end{proof}

\begin{lem}
	Let $\mathcal{A}$ a DPA, $\sim$ the relation of priority almost-equivalence, and $\mathcal{S}$ be the Schewe automaton. Then $\mathcal{A}$ and $\mathcal{S}$ are priority almost-equivalent.
\end{lem}

\begin{proof}
	Let $\mathcal{A} = (Q, \Sigma, q_0^\mathcal{A}, \delta_\mathcal{A}, c)$ and $\mathcal{S} = (Q, \Sigma, q_0^\mathcal{S}, \delta_\mathcal{S}, c)$. Let $\alpha \in \Sigma^\omega$. We have to show that $\lambda_\mathcal{A}(q_0^\mathcal{A}, \alpha)$ and $\lambda_\mathcal{S}(q_0^\mathcal{S}, \alpha)$ differ in only finitely many positions. For that, let $a_0 a_1 \cdots \in Q^\omega$ and $s_0 s_1 \cdots \in Q^\omega$ be the respective runs of the automata on $\alpha$.
	
	\paragraph{Claim 1} For all $i$, $\mathcal{A}_{a_i}$ and $\mathcal{A}_{s_i}$ are priority almost-equivalent. ($a_i \sim s_i$)
	
	For $i = 0$, we have $a_i = q_0^\mathcal{A}$ and $s_i = q_0^\mathcal{S} = r_{[q_0^\mathcal{A}]_\sim}$. By definition, $s_i = r_{[q_0^\mathcal{A}]_\sim} \in [q_0^\mathcal{A}]_\sim$, so $s_i \sim a_i$.
	
	Using induction, assume $a_i \sim s_i$ and consider $i+1$. We seperate two cases: If $\delta_\mathcal{S}(s_i, \alpha(i)) = \delta_\mathcal{A}(s_i, \alpha(i))$, then $a_{i+1} \sim s_{i+1}$ follows from $\sim$ being a congruence relation.
	
	For the second case, consider $\delta_\mathcal{S}(s_i, \alpha(i)) = r_{[p]_\sim}$, where $\delta_\mathcal{A}(s_i, \alpha(i)) = p$. Again we have $s_{i+1} = r_{[p]_\sim} \in [p]_\sim$, so $s_{i+1} \sim p$. Since $\sim$ is a congruence relation, we have $\delta_\mathcal{A}(a_i, \alpha(i)) \sim \delta_\mathcal{A}(s_i, \alpha(i))$, which is $a_{i+1} \sim p$ and therefore $a_{i+1} \sim s_{i+1}$ by transitivity.
	
	\paragraph{Claim 2} $\lambda_\mathcal{A}(q_0^\mathcal{A}, \alpha)$ and $\lambda_\mathcal{S}(q_0^\mathcal{S}, \alpha)$ differ in only finitely many positions.
	
	We can see from the definition of $\mathcal{S}$ that the \enquote{new type of transition} is taken only when the target state of $\delta_\mathcal{A}$ is strictly bigger w.r.t. $\preceq_\text{reach}^\mathcal{A}$. Since this is a partial order on $Q$, this means in particular that from some point $k$ onwards, only the transition type $\delta_\mathcal{S}(q, a) = \delta_\mathcal{A}(q, a)$ is taken. Hence, $s_k s_{k+1} \cdots$ is the valid run of $\mathcal{A}_{s_k}$ on some suffix $\beta$ of $\alpha$. If now $\lambda_\mathcal{A}(q_0^\mathcal{A}, \alpha)$ and $\lambda_\mathcal{S}(q_0^\mathcal{S}, \alpha)$ would differ at infinitely many positions, then also $\lambda_\mathcal{A}(a_k, \beta)$ and $\lambda_\mathcal{A}(s_k, \beta)$ would (as these are suffixes of the former). However, we have shown in claim 1 that $\mathcal{A}_{a_k}$ and $\mathcal{A}_{s_k}$ are priority almost-equivalent.
\end{proof}


\begin{lem}
	Let $\mathcal{A}$ a DPA, $\sim$ the relation of priority almost-equivalence, and $\mathcal{S}$ be the Schewe automaton. If $p$ and $q$ are priority almost-equivalent and reachable states in $\mathcal{S}$, then they lie in the same SCC.
\end{lem}

\begin{proof} 
	Let $\sim$ the relation of priority almost-equivalence.
	
	\paragraph{Claim 1} If $p$ and $q$ are reachable in $\mathcal{S}$ and $\mathcal{A}_p$ and $\mathcal{A}_q$ are priority almost-equivalent, then $\mathcal{S}_p$ and $\mathcal{S}_q$ are priority almost-equivalent.
	
	Assume towards a contradiction that $p, q$ form a counterexample with $\lambda_\mathcal{S}(p, \alpha)$ and $\lambda_\mathcal{S}(q, \alpha)$ differing at infinitely many positions. Let $\rho_p$, $\rho_q$, $\pi_p$, and $\pi_q$ be the runs of $\mathcal{A}_p$, $\mathcal{A}_q$, $\mathcal{S}_p$, and $\mathcal{S}_q$ on $\alpha$ respectively.	Similar to the proof of \ref{}, we can  %TODO
	
	\paragraph{Claim 2} Let $p$ and $q$ be reachable states in $\mathcal{S}$ that are priority almost-equivalent and in $\mathcal{A}$ there is a path $\rho$ from $p$ to $q$. Then $\rho$ is also a valid path in $\mathcal{S}$.
	
	Let $\rho = p_0 \cdots p_m$ with $p_0 = p$ and $p_m = q$. Assume towards a contradiction that $k$ is the first position at which this path is not valid in $\mathcal{S}$, i.e. $\delta_\mathcal{S}(p_k, a) \neq p_{k+1}$. That means that the transition was redirected to $\delta_\mathcal{S}(p_k, a) = r_{[p_{k+1}]_\sim}$. Therefore, $r_{[p_k]_\sim} \prec_\text{reach}^\mathcal{A} r_{[p_{k+1}]_\sim}$ by definition of the Schewe automaton. Let $u, v \in \Sigma^*$ with $p_0 \overset{u}{\underset{\mathcal{A}}{\rightarrow}} p_k \overset{a}{\underset{\mathcal{A}}{\rightarrow}} p_{k+1} \overset{v}{\underset{\mathcal{A}}{\rightarrow}} p_m$.
	
	We define $\delta^*_\mathcal{A}(p_{k+1}, vu) = s$ and $\delta^*_\mathcal{A}(r_{[p_{k+1}]_\sim}, vu) = t$. Since $\mathcal{A}_{p_{k+1}}$ and $\mathcal{A}_{r_{[p_{k+1}]_\sim}}$ are priority almost-equivalent and $\sim$ is a congruence relation, also $\mathcal{A}_s$ and $\mathcal{A}_t$ are priority almost-equivalent. The former is priority-almost equivalent to $\mathcal{A}_{p_k}$. That means, in $\mathcal{A}$, we have $t \sim s \sim p_k \sim r_{[p_k]_\sim}$.
	
	On the other hand we have shown that via $vu$ we can reach $t$ from $r_{[p_{k+1}]_\sim}$, so $r_{[p_{k+1}]_\sim} \preceq_\text{reach}^\mathcal{A} t$ and therefore $r_{[p_k]_\sim} \preceq_\text{reach}^\mathcal{A} t$. This together with the fact that $t \sim r_{[p_k]_\sim}$ contradicts the choice of $r_{[p_k]_\sim}$ as a $\preceq_\text{reach}^\mathcal{A}$-maximal element in its equivalence class. Hence, $k$ cannot exist and $\rho$ is a valid path in $\mathcal{S}$.
	
	\paragraph{Claim 3} In the (not-minimized) Schewe automaton $\mathcal{S}$, for all reachable states $q$ we have $q \preceq_\text{reach}^\mathcal{S} r_{[q]_\sim}$.
	
	Let $q$ be a reachable state, so there is a run $q_0 \cdots q_m$ in $\mathcal{S}$ on $w$ with $q_m = q$. By definition of the automaton, there is a position $k$ on this run at which a $\sim$-equivalence class $\mathfrak{c}$ is entered with $r_{[q]_\sim} \preceq_\text{reach}^\mathcal{A} r_\mathfrak{c}$. At latest this happens when $[q]_\sim$ is reached for the first time, as then the transition is directed to $r_{[q]_\sim}$ directly. Let $k' \geq k$ be the position in this run at which $[q]_\sim$ is entered for the first time.
	
	Let $p_k \cdots p_{k'}$ be the run of $\mathcal{A}$ on $w(k) \cdots w(k'-1)$ with $p_k = q_k$. Using induction we can show that $\mathcal{A}_{p_i}$ and $\mathcal{A}_{q_i}$ are priority almost-equivalent for all $k \leq i \leq k'$. For $i = k$ this is obvious since $p_k = q_k$. Otherwise consider index $i+1$. Note that because $\sim$ is a congruence relation, $\mathcal{A}_{\delta_\mathcal{A}(p_i, w(i))}$ and $\mathcal{A}_{\delta_\mathcal{A}(q_i, w(i))}$ are priority almost-equivalent. The definition of the Schewe automaton sets $\delta_\mathcal{S}(q_i, w(i))$ either to the state $\delta_\mathcal{A}(q_i, w(i))$ or to its representative; in both cases, $\mathcal{A}_{\delta_\mathcal{S}(q_i, w(i))} = \mathcal{A}_{q_{i+1}}$ is priority almost-equivalent to $\mathcal{A}_{\delta_\mathcal{A}(q_i, w(i))}$ and therefore to $\mathcal{A}_{\delta_\mathcal{A}(p_i, w(i))} = \mathcal{A}_{q_i}$.
	
	This observation together with claim 1 implies that all $\mathcal{S}_{p_i}$ and $\mathcal{S}_{q_i}$ are priority almost-equivalent as well. In particular, $p_{k'} \sim q$ (in $\mathcal{S}$). 
	

	\paragraph{Claim 4} If $p$ and $q$ are priority almost-equivalent in $\mathcal{S}$ and reachable, then they lie in the same SCC.

	%TODO
\end{proof}

\begin{lem}
	There is no DPA priority almost-equivalent to $\mathcal{A}$ that is smaller than $\mathcal{S}_m$.
\end{lem}

\begin{lem}
	The priority almost-equivalence of a DPA $\mathcal{A}$ can be computed in $\mathcal{O}(|\mathcal{A}|^2)$.
\end{lem}

\begin{theorem}
	For a given DPA $\mathcal{A}$, a minimal almost priority-equivalent automaton can be computed in $\mathcal{O}(|\mathcal{A}|^2)$. 
\end{theorem}
	


\begin{defn}
	Let $\mathcal{A} = (Q, \Sigma, q_0, \delta, c)$ be a DPA. We define the \textbf{Moore-minimization} $\mathcal{B}$ as the parity automaton corresponding to the minimal Moore automaton of $\mathcal{A}$. That means it is the minimal automaton such that $\lambda_\mathcal{A}(\alpha) = \lambda_\mathcal{B}(\alpha)$ for all $\alpha \in \Sigma^\omega$.
	
	More specifically, we define the congruence relation $\sim \subseteq Q \times Q$ by $p \sim q$ iff $\forall w \in \Sigma^*: \lambda_\mathcal{A}(p, w) = \lambda_\mathcal{A}(q, w)$. Then $\mathcal{A}'$ is constructed from $\mathcal{A}$ by removing unreachable states (from $q_0$). $\mathcal{B} = (\bigslant{Q}{\sim}, \Sigma, [q_0]_\sim, \delta_\mathcal{B}, c_\mathcal{B})$ is the quotient automaton of $\bigslant{\mathcal{A}'}{\sim}$ with $\delta_\mathcal{B}([q]_\sim, a) = [\delta(q, a)]_\sim$ and $c_\mathcal{B}([q]_\sim) = c(q)$.
\end{defn}

\begin{lem}
	For a given DPA $\mathcal{A}$, the Moore-minimization can be computed in $\mathcal{O}$.
\end{lem}





