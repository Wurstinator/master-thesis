\section{Labeled SCC Filter}
\begin{defn}
	Let $\mathcal{A} = (Q, \Sigma, q_0, \delta, c)$ be a DPA. We define $\mathcal{A}\upharpoonright^c_{= k} := \mathcal{A}\upharpoonright_P$ with $P = \{q \in Q \mid c(q) = k\}$. Analogously, we define $\mathcal{A}\upharpoonright^c_{> k}$.
	
	We define a relation $R_k \subseteq Q \times Q$ such that $(p, q) \in R_k$ if and only if all of the following are true:
	\begin{enumerate}
		\item $\min \{c(p), c(q)\} > k$
		\item $p \equiv_L q$
		\item $p \equiv_M^{\leq k} q$
		\item In $\mathcal{A}\upharpoonright^c_{> k}$, $p$ and $q$ lie in different SCCs.
	\end{enumerate}
	
	We define $\equiv_\text{LSF}^k \,\subseteq Q \times Q$ to be the reflexive and transitive closure of $R_k$.
\end{defn}

\begin{lem}
	$\equiv_\text{LSF}^k$ is an equivalence relation.
\end{lem}

\begin{defn}
	Let $\mathcal{A}$ be a DPA and $k \in \mathbb{N}$. We define $\preceq_k \subseteq Q \times Q$ to be a total extension of the reachability preorder in $\mathcal{A}\upharpoonright^c_{\geq k}$.
	
	Let $\lambda$ be an equivalence class of $\equiv_\text{LSF}^k$. Let $r \in \lambda$ be a representative of $\lambda$ that is $\preceq_k$-maximal. We set $\lambda' := \{q \in \lambda \mid q \prec_k r\} \cup \{r\}$. We call an automaton $\mathcal{A}'$ a \emph{$\text{LSF}_\lambda^k$-merge} of $\mathcal{A}$ if it is a representative merge of $\mathcal{A}$ w.r.t. $\lambda'$ that uses the representative $r_{\lambda'} = r$.
\end{defn}

\begin{theorem}
	Let $\mathcal{A}$ be a DPA and let $\mathcal{A}'$ be a $\text{LSF}_\lambda^k$-merge of $\mathcal{A}$. Then $L(\mathcal{A}) = L(\mathcal{A}')$.
	\label{thm:lsf:correctness}
\end{theorem}

\begin{proof}
	Let $r_\lambda$ be the representative that is used in the construction of $\mathcal{A}'$. Let $q \in Q'$ be a state in the representative merge and let $\alpha \in \Sigma^\omega$. Let $\rho$ and $\rho'$ be the runs of $\mathcal{A}$ and $\mathcal{A}'$ on $\alpha$ starting from $q$. We claim that $\rho$ is accepting iff $\rho'$ is accepting.
	
	By Lemma \ref{lem:tremoore:cong_stays_in_merge}, we know that $\rho(i) \equiv_L \rho'(i)$ and $\rho(i) \equiv_M^{\leq k} \rho'(i)$ for all $i$. If there is a position $n$ from which on $\rho'[n,\omega]$ is both a valid run in $\mathcal{A}$ and $\mathcal{A}'$, then we know that $\rho$ is accepting if and only if $\rho'$ is accepting since $\rho(n) \equiv_L \rho'(n)$.
	
	If $\rho'$ visits infinitely many states with priority equal to or less than $k$, then $\rho$ and $\rho'$ share the same minimal priority that is visited infinitely often and thus have the same acceptance.
	
	For the last case, assume that $\rho'$ uses infinitely many redirected edges but from some point $n_1$ on stays in $\mathcal{A}\upharpoonright^c_{>k}$. Let $n_3 > n_2 > n_1$ be the next two positions at which $\rho'$ uses a redirected edge, i.e. $\delta(\rho'(n_2), \alpha(n_2)) \neq \delta'(\rho'(n_2), \alpha(n_2))$ and analogous for $n_3$. Note that $\delta'(\rho'(n_2), \alpha(n_2)) = \delta'(\rho'(n_3), \alpha(n_3)) = r_\lambda$, since all redirected transition target the representative state. Let we call $\delta(\rho'(n_3), \alpha(n_3)) = q$. Since between $n_2$ and $n_3$ no redirected transition is taken, $\rho'[n_2, n_3]$ is a valid path in $\mathcal{A}$, so we have $r_\lambda \preceq_k q$ by choice of $n_1$. The fact that transitions to $q$ are redirected to $r_\lambda$ however requires that $q \prec_k r_\lambda$, which would be a contradiction.
\end{proof}


\begin{lem}
	Let $\mathcal{A}$ be a DPA and let $\mathcal{A}'$ be a $\text{LSF}_\lambda^k$-merge of $\mathcal{A}$. Let $\equiv_\text{LSF}^l$ be the LSF-relation in $\mathcal{A}$ and let $\equiv_\text{LSF'}^l$ be the LSF-relation in $\mathcal{A}'$. If $l \leq k$, then $\equiv_\text{LSF}^l \upharpoonright_{Q' \times Q'} \,\supseteq\, \equiv_\text{LSF'}^l$.
	\label{lem:lsf:constr_does_not_change_lower_k}
\end{lem}

\begin{proof}
	Let $R_l$ and $R'_l$ be the relations used in the definition of $\equiv_\text{LSF}^l$ and $\equiv_\text{LSF'}^l$. We prove $R'_l \subseteq R'_l \upharpoonright_{Q' \times Q'}$. If that is true, then so is the statement of our Lemma. We do so by considering the four properties of $R_l$ individually.
	
	The first point is clear; $c' = c \upharpoonright_{Q'}$, so $c'(p) = c(p)$ and $c'(q) = c(q)$.
	
	For the second point, consider Theorem \ref{thm:lsf:correctness}. By making $p$ or $q$ the initial state of our DPA, we observe that neither state has its language changed by the construction, so they must still be equal.
	
	For the third point, let $\equiv_M^{\unlhd l}$ be the $l$-threshold Moore equivalence in $\mathcal{A}'$. Let $w \in \Sigma^*$ be an arbitrary word, $p \equiv_M^{\leq l}$, $p' := (\delta')^*(p, w)$, and $q' := (\delta')^*(q, w)$. Using Lemma \ref{lem:tremoore:cong_stays_in_merge}, we know that, since $p \equiv_M^{\leq l} q$, also $p' \equiv_M^{\leq l} q'$. In particular, this means $c(p') =^{\leq l} c(q')$. As $w$ was chosen to be arbitrary, that means $p \equiv_M^{\unlhd l} q$.
	
	Lastly, for the fourth point, assume that there are states $p, q$ which lie in different SCCs in $\mathcal{A} \upharpoonright^c_{> l}$ but not in $\mathcal{A}' \upharpoonright^c_{> l}$. Without loss of generality, we assume that in $\mathcal{A} \upharpoonright^c_{> l}$, $p$ is not reachable from $q$. In $\mathcal{A}' \upharpoonright^c_{> l}$ however, this is possible, so let $\rho'$ be a path from $q$ to $p$. We can assume $\rho'$ to pay exactly one visit to $\lambda$; there has to be at least one visit, as otherwise the path would also be available in $\mathcal{A}$; if there would be multiple visits, all of them would end at $r_\lambda$, so we could cut those parts from the run. Let $uv$ be words that induce that run, i.e. $\delta^*(q, u) \in \lambda$ and $\delta^*(r_\lambda, v) = p$.
	
	We distinguish two cases. In the first case, $q$ is reachable from $p$ in $\mathcal{A}$ by some word $w$. Here, consider reading the word $vwu$ from $r_\lambda$ in $\mathcal{A}$. The run moves to $p$ by $v$, then to $q$ by $w$, then to $\delta^*(q, u) \in \lambda$. $\delta^*(q, u)$ was the state from which the redirected transition was taken in $\rho'$, so it cannot be reachable from $r_\lambda$ by definition of the merge. This is a contradiction.
	
	For the second case, $q$ is not reachable from $p$ in $\mathcal{A}$. Since the two states lie in a common SCC in $\mathcal{A}'$ however, there is a path $\pi'$ from $p$ to $q$. With the same argument as before, we can assume that $\pi'$ leads to $r_\lambda$ via some word $u'$ and from there to $q$ via some $v'$. As in the first case, the word $v' u$ gives us a path from $r_\lambda$ to $\delta^*(q, u)$ which is a contradiction.
\end{proof}

The two previous statements provide us with a possible algorithm to perform state space reduction with the LSF method. Starting at $k = \min c(Q) - 1$ and iterating up to $\max c(Q)$, compute $\equiv_\text{LSF}^k$ and build representative merges of each equivalence class. By Lemma \ref{lem:lsf:constr_does_not_change_lower_k}, strictly iterating once through all $k$ in ascending order gives us all possible merges.

The final question that remains is how to compute $\equiv_\text{LSF}^k$ itself. This can be done rather easily 




